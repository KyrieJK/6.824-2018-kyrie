# 分布式系统基础理论(四)	基础模型

前面几篇文章分别介绍了几个分布式系统中经典的理论。在了解完这些内容后，我们开始学习分布式系统的整体架构，各个组件作用功能，运行时态的各个组件间互动的关系，核心逻辑在各个组件的调用逻辑。在了解整体架构后，然后再学习各个组件具体工作原理。

## 分布式系统基本模型

![](https://raw.githubusercontent.com/KyrieJK/Figurebed/master/img/20191118221245.png)

​																			图1 分布式系统模型

## 节点

节点是指一个可以独立按照分布式协议完成一组逻辑的程序个体。在具体的工程项目中，一个节点往往是一个操作系统上的进程。在本文的模型中，认为节点是一个完整的、不可分割的整体，如果某个程序进程实际上由若干相对独立部分构成，则在模型中可以将一个进程进一步划分为多个节点。本文不考虑拜占庭问题，认为节点始终按照约定的分布式协议工作。

## 通信

节点与节点之间是完全独立、相互隔离的。节点之间传递信息的唯一方式是通过不可靠的网络进行通信。即一个节点可以向其他节点通过网络发送消息，但发送消息的节点无法确认消息是否被对端节点成功完整获取。

## 存储

节点可以通过将数据写入与节点在同一台机器的本地存储设备保存数据。通常的存储设备有磁盘、SSD等。存储、读取数据的节点称为有状态的节点，反之称为无状态的节点。如果某个节点A存储数据的方式是将数据通过网络发送到另一个节点B，由节点B负责将数据存储到节点B的本地存储设备，那么不能认为节点A是有状态的节点，而只有节点B是有状态的节点。

## 异常

异常是常态，分布式系统核心问题之一就是处理各种异常情况。

1. 机器宕机

   宕机故障是最常见的异常之一。在大型集群中每天宕机发生的概率为千分之一。在工程实践中，一台宕机的机器恢复时间通常认为是24小时，一般需要人工介入重启机器。当发生宕机时，节点无法进入正常工作状态，称为unavailable(不可用)状态。**机器重启后，机器上的节点可以重新启动，但是节点会丢失所有的内存信息**。在某些分布式系统中，节点可以通过读取本地存储设备中的信息或通过读取其他节点数据的方式回复内存信息，从而恢复到某一宕机前的状态，从而重新进入正常工作状态，从unavailable转变为available。某些分布式系统中的某些**无状态节点**则无需读取任何信息就可以立刻重新“可用”。**节点从宕机后的不可用状态到可用状态称为宕机恢复**。

2. 网络异常

   - 消息丢失：这是最常见的网络异常。对于常见的IP网络，网络层不保证数据报文的可靠传递，在发生网络拥塞、路由变动、设备异常等情况时，都可能发生传输消息丢失。由于网络数据丢失的存在，这就决定了分布式系统必须有能力处理网络数据丢失的异常情况。某些节点如果完全无法正常通信，这种情况叫做网络分化(network partition)。
   - 消息乱序：指节点发送的网络消息有一定的概率不是按照发送的顺序依次到达目的节点。也叫做网络报文乱序异常。在设计分布式系统时，需要考虑使用序列号等机制处理网络消息的乱序问题，使得无效的、过期的网络消息不影响系统的正确性。
   - 数据错误：网络中传输的数据可能会发生比特错误，从而进一步导致数据错误。通常使用一定的校验码机制可以较为简单的检查出网络数据的错误，从而丢弃错误的数据。
   - 不可靠的TCP：TCP协议为应用层提供了可靠的、面向连接的传输服务。TCP协议设计初衷就是在不可靠的网络之上建立可靠的传输服务。但是在分布式系统中并不认为所有网络通信都基于TCP协议则通信就是可靠的。一方面，TCP协议保证了TCP协议栈之间的可靠的传输，但是无法保证两个上层应用之间的可靠通信。当某个应用层程序通过TCP的系统调用发送一个网络消息时，即使TCP系统调用返回成功，也仅仅只能代表该消息被本机的TCP协议栈接受，一般这个消息是被放入了TCP协议栈的缓冲区中。即使目的机器的TCP协议栈后续也顺利接收到发送过来的消息，并发送了ack包，也仅仅意味着消息达到了对方的TCP协议栈，而不能认为消息被目标应用程序进程接收到并正确处理了。当发送过程中出现宕机等异常时，TCP协议栈缓冲区中的消息有可能被丢失从而无法被目标节点正确处理。还有一种特殊情况，在网络中断前，某数据包已经被目标进程正确处理，之后网络立刻中断，由于接收方的TCP协议栈发送的ack数据包始终被丢失，发送方的TCP协议栈也有可能告知发送进程发送失败。另一方面，TCP协议只能保证同一个TCP链接内的网络消息不乱序，但是TCP链接之间的网络消息顺序则无法保证。在分布式系统中，一个节点向另一个节点发送数据，有可能是先后使用多个TCP链接发送，也有可能是同时并发多个TCP链接发送，但是发送进程不能认为先调用TCP系统调用发送的消息就一定会比后发的消息先到达目标节点并被处理。

3. 分布式系统的三态

   由于网络异常的存在，分布式系统中请求结果存在“三态”概念。分布式系统和单机系统最大的区别在于“节点之间需要进行**网络通信**”。有网络通信就会出现网络异常，分布式系统的复杂度几乎全部源于此。在单机系统中，我们调用一个函数实现一个功能，这个函数的返回值无非就是“成功”，“失败”两种状态，只要不发生宕机其执行结果都是确定的。但是在分布式系统中由于有网络通信的存在，如果某个节点向目标节点发起RPC调用，即某个节点A向另一个节点B发送一个消息，节点B根据收到的消息内容完成某些操作，并将操作的结果通过另一个消息返回给节点A，那么这个RPC执行的结果有三种状态：“成功”，“失败”，“超时”，称之为分布式系统的三态。

   如果请求RPC的节点A在给定的时间内没有收到执行RPC的节点B返回的消息，则认为该操作“超时”。对于超时的请求，我们无法获知该请求是否被节点B成功执行了。有两种不同的情况，需要逐一分析。如果超时是由于节点A发向节点B的请求消息丢失造成的，则该操作肯定没有被节点B成功执行。另一种情况是如果节点A成功的向节点B发送了请求消息，且节点B也成功的执行了该RPC请求，但节点B发向节点A的结果消息在传输过程中丢失或者节点B在执行完该操作后立刻宕机没有能够发出结果消息，从而造成从节点A看来请求出现超时。一旦发生超时，请求方无法获知RPC的执行结果。

   ![image-20191119001206134](/Users/jkerving/Library/Application Support/typora-user-images/image-20191119001206134.png)

   举个例子来说，我们在网上银行进行转账操作，当系统超时，页面提示“如果系统长时间未返回，请检查账户余额以确认交易是否成功”。

   分布式系统一般需要区别对待RPC的“成功”、“失败”、超时“”三种状态，当出现“超时”时可以通过发起读取数据的操作以验证RPC是否成功。另外一种做法是在设计分布式系统协议时，将执行步骤设计为可重试的，即具有所谓的“幂等性”。例如覆盖写就是一种常见的幂等性操作，因为在同一偏移量的重复的覆盖写最终的结果都相等。如果使用可重试的设计，当出现“失败”和“超时”状态，发送方就可以一直重试操作直到返回“成功”状态。这样，即使超时的操作实际上已经成功了，重试操作也不会对正确性造成影响，从而简化了分布式系统对于RPC调用的设计。

4. 存储数据丢失

   数据丢失指节点存储的数据不可被读取或者读取出的数据错误。数据丢失是另一类常见的异常。尤其是使用机械硬盘做存储介质时，硬盘损坏的概率较大。对于有状态节点来说，数据丢失意味着状态丢失，通常只能从其他节点读取、恢复存储的状态。

5. 无法归类的异常

6. 异常处理的原则